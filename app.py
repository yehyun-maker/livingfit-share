import streamlit as st
st.set_page_config(page_title="ë¦¬ë¹™í• ìŠ¤ì½”ì–´", page_icon="ğŸ ", layout="centered")

st.title("ğŸ  ë¦¬ë¹™í• ìŠ¤ì½”ì–´")
st.caption("ë‚´ ì§‘ ë§ˆë ¨ì„ ìœ„í•œ ê¸ˆìœµ ê±´ì „ì„± ê°€ì´ë“œ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# INPUT â–¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

st.header("ğŸ“Š ê¸°ë³¸ ì •ë³´ ì…ë ¥")

# ì„œìš¸ 25ê°œ ìì¹˜êµ¬ ëª©ë¡
seoul_gu = [
    "ì¢…ë¡œêµ¬", "ì¤‘êµ¬", "ìš©ì‚°êµ¬", "ì„±ë™êµ¬", "ê´‘ì§„êµ¬", "ë™ëŒ€ë¬¸êµ¬", "ì¤‘ë‘êµ¬", "ì„±ë¶êµ¬", "ê°•ë¶êµ¬", "ë„ë´‰êµ¬",
    "ë…¸ì›êµ¬", "ì€í‰êµ¬", "ì„œëŒ€ë¬¸êµ¬", "ë§ˆí¬êµ¬", "ì–‘ì²œêµ¬", "ê°•ì„œêµ¬", "êµ¬ë¡œêµ¬", "ê¸ˆì²œêµ¬", "ì˜ë“±í¬êµ¬", "ë™ì‘êµ¬",
    "ê´€ì•…êµ¬", "ì„œì´ˆêµ¬", "ê°•ë‚¨êµ¬", "ì†¡íŒŒêµ¬", "ê°•ë™êµ¬",
]

col1, col2 = st.columns(2)

with col1:
    # 1) ì£¼íƒ ê°€ê²© (ì–µ ì› ë‹¨ìœ„ ì…ë ¥ â†’ ë§Œì› ë‹¨ìœ„ë¡œ ë³€í™˜)
    house_price_uk = st.text_input(
        "êµ¬ë§¤í•˜ë ¤ëŠ” ì£¼íƒ ê°€ê²© (ì–µì›)",
        placeholder="ì˜ˆ : 8.5",  # 8ì–µ 5ì²œë§Œì›
    )

    # ì´í›„ ê³„ì‚°ì—ì„œ ê·¸ëŒ€ë¡œ ì“°ë˜ house_price_man(ë§Œì›)ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ë³€í™˜
    house_price_man = float(house_price_uk or 0) * 10_000

    # 4) ì—°ì†Œë“ (ë§Œì› ë‹¨ìœ„)
    annual_income_man = st.text_input(
        "ì—°ì†Œë“ (ë§Œì›)",
        placeholder = "ì˜ˆ : 3000",
    )

    # 6) ëŒ€ì¶œê¸°ê°„ (ë…„)
    loan_term_years = st.text_input(
        "ëŒ€ì¶œê¸°ê°„ (ë…„)",
        placeholder = "3",
    )

with col2:
    # 2) ì£¼íƒ ìœ„ì¹˜ (í…ìŠ¤íŠ¸)
    location = st.selectbox(
        "êµ¬ë§¤í•˜ë ¤ëŠ” ì£¼íƒ ìœ„ì¹˜ (ì„œìš¸ 25ê°œ ìì¹˜êµ¬)",
        seoul_gu,
        index=0,  # ê¸°ë³¸ê°’: ê°•ë‚¨êµ¬
    )

    # 5) ê¸°ì¡´ ëŒ€ì¶œì˜ **ì—°ê°„** ì›ë¦¬ê¸ˆ ìƒí™˜ì•¡ (ë§Œì› ë‹¨ìœ„)
    existing_annual_pay_man = st.text_input(
        "ê¸°ì¡´ ëŒ€ì¶œì˜ ì—°ê°„ ì›ë¦¬ê¸ˆ ìƒí™˜ì•¡ (ë§Œì›)",
        placeholder="ì˜ˆ : 420",  # 1ë…„ ë™ì•ˆ ê°šëŠ” ì›ë¦¬ê¸ˆ ì´ì•¡ì„ ë§Œì› ë‹¨ìœ„ë¡œ ì…ë ¥
    )

    # 7) ê¸ˆë¦¬ (%)
    interest_rate = st.text_input(
        "ê¸ˆë¦¬ (%)",
        placeholder = "2.5",
    )

    # 3) ì£¼íƒ ë³´ìœ  ì—¬ë¶€ (ë¼ë””ì˜¤)
    homeownership = st.radio(
        "í˜„ì¬ ì£¼íƒ ë³´ìœ  ì—¬ë¶€",
        options=["ìƒì•  ìµœì´ˆ êµ¬ë§¤", "0(ì²˜ë¶„ ì¡°ê±´ë¶€ 1ì£¼íƒì)", "1ì£¼íƒ ì´ìƒ"],
        horizontal=False,
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# LTV í•œë„ ê³„ì‚° â–¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
non_regulated = {
    "ë…¸ì›êµ¬", "ë„ë´‰êµ¬", "ê°•ë¶êµ¬", "ê¸ˆì²œêµ¬", "ê´€ì•…êµ¬", "êµ¬ë¡œêµ¬", "ì¤‘ë‘êµ¬"
}

# ì£¼íƒ ë³´ìœ Â·ì§€ì—­ë³„ LTV ìƒí•œ
if homeownership == "ìƒì•  ìµœì´ˆ êµ¬ë§¤":
    ltv_limit = 0.70
elif homeownership == "0(ì²˜ë¶„ ì¡°ê±´ë¶€ 1ì£¼íƒì)":
    ltv_limit = 0.70 if location in non_regulated else 0.50
else:  # "1+"
    ltv_limit = 0.00

# â†“ ì´í›„ ê³„ì‚°ì‹ì—ì„œ ê³ ì •ê°’ ëŒ€ì‹  ltv_limit ì‚¬ìš©
# ì£¼íƒ ë³´ìœ Â·ì§€ì—­ë³„ LTV ìƒí•œ
if homeownership == "ìƒì•  ìµœì´ˆ êµ¬ë§¤":
    ltv_limit = 0.70
elif homeownership == "0(ì²˜ë¶„ ì¡°ê±´ë¶€ 1ì£¼íƒì)":
    ltv_limit = 0.70 if location in non_regulated else 0.50
else:  # "1ì£¼íƒ ì´ìƒ"
    ltv_limit = 0.00

# â¤ LTV ê¸°ì¤€ ëŒ€ì¶œê°€ëŠ¥ì•¡(ë§Œì›) ê³„ì‚°
house_price_val        = float(house_price_man or 0)
loan_amount_ltv_man    = house_price_val * ltv_limit     # ë§Œì› ë‹¨ìœ„


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DSR 40 % í•œë„ ê¸°ë°˜ ìµœëŒ€ ëŒ€ì¶œê°€ëŠ¥ì•¡ ê³„ì‚° â–¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DSR_LIMIT = 0.40

annual_income_val       = float(annual_income_man       or 0)
existing_annual_pay_val = float(existing_annual_pay_man or 0)
loan_term_val           = int(loan_term_years           or 0)
interest_val            = float(interest_rate           or 0)

stress_rate = interest_val + 1.5  # %

# ìƒˆ ëŒ€ì¶œ ì—°ê°„ ìƒí™˜ì•¡ í•¨ìˆ˜
def annual_payment_man(principal_man, rate_pct, term_years):
    if principal_man == 0 or term_years == 0:
        return 0.0
    r = rate_pct / 100 / 12
    n = term_years * 12
    if r == 0:
        return principal_man / term_years
    m_won = principal_man * 10_000 * r / (1 - (1 + r) ** -n)
    return m_won * 12 / 10_000  # ë§Œì› ë‹¨ìœ„

# â‘  ê¸°ì¡´ ëŒ€ì¶œ ì—°ê°„ ìƒí™˜ì•¡
old_pay_man = existing_annual_pay_val

# â‘¡ DSR ìƒí•œì´ í—ˆìš©í•˜ëŠ” ì—°ê°„ ìƒí™˜ ì—¬ë ¥
max_annual_pay_man   = annual_income_val * DSR_LIMIT
avail_annual_pay_man = max(max_annual_pay_man - old_pay_man, 0)

# â‘¢ ì›” ìƒí™˜ ì—¬ë ¥(ì›) â†’ ìµœëŒ€ ëŒ€ì¶œê°€ëŠ¥ì•¡(ë§Œì›)
P_won = avail_annual_pay_man / 12 * 10_000     # ì›” ìƒí™˜ ê°€ëŠ¥ì•¡
r     = stress_rate / 100 / 12
n     = loan_term_val * 12

if P_won == 0 or r == 0 or n == 0:
    max_loan_dsr_man = 0
else:
    max_loan_won   = P_won * (1 - (1 + r) ** -n) / r
    max_loan_dsr_man = max_loan_won / 10_000

# â‘£ ë‘ ê·œì œ ì¤‘ ì‘ì€ ê°’ì„ ì‹¤ì œ í•œë„ë¡œ
possible_loan_man = min(loan_amount_ltv_man, max_loan_dsr_man)


# â¤ ê¸ˆì•¡ì„ â€œ00ì–µ 00ë§Œâ€ í˜•íƒœë¡œ ë°”ê¾¸ëŠ” í—¬í¼
def fmt_man(man):
    uk  = int(man) // 10_000        # ì–µ
    rem = int(man) % 10_000         # ë§Œ
    if uk and rem:
        return f"{uk}ì–µ {rem}ë§Œ"
    elif uk:      # ë§Œì›ì´ 0
        return f"{uk}ì–µ"
    else:
        return f"{rem}ë§Œ"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.button("ğŸ’° ê³„ì‚°í•˜ê¸°"):

    st.success(
        f"LTV = {ltv_limit*100:.0f}% / DSR = 40%\n\n"
        f"â€¢ LTV ê¸°ì¤€ ëŒ€ì¶œê°€ëŠ¥ì•¡: {fmt_man(loan_amount_ltv_man)}\n"
        f"â€¢ DSR ê¸°ì¤€ ëŒ€ì¶œê°€ëŠ¥ì•¡: {fmt_man(max_loan_dsr_man)}\n"
        f"â†’ ìµœì¢… ëŒ€ì¶œê°€ëŠ¥ì•¡: **{fmt_man(possible_loan_man)}**"
    )

    if homeownership == "ìƒì•  ìµœì´ˆ êµ¬ë§¤":
        st.warning(
            "6ê°œì›” ë‚´ ì „ì… ì˜ë¬´ ë¶€ê³¼. ì´ë¥¼ ì§€í‚¤ì§€ ì•Šì„ ì‹œ **ëŒ€ì¶œ íšŒìˆ˜** ë° "
            "**3ë…„ ê°„ ì£¼íƒ ëŒ€ì¶œ ì œí•œ** ëŒ€ìƒì´ ë  ìˆ˜ ìˆìŒ"
        )
    elif homeownership == "1ì£¼íƒ ì´ìƒ":
        st.error("ëŒ€ì¶œì´ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ¡ ë‚˜ì˜ ë¦¬ë¹™í• ìŠ¤ì½”ì–´ëŠ”? â–¼   â€• ì •ì„±ì  ìš”ì¸ ì…ë ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ¡ ë‚˜ì˜ ë¦¬ë¹™í• ìŠ¤ì½”ì–´ëŠ”?")

# 1) í˜„ì¬ ê±°ì£¼ì§€
current_location = st.selectbox(
    "í˜„ì¬ ê±°ì£¼ ì¤‘ì¸ ì§€ì—­ (ì„œìš¸ 25ê°œ ìì¹˜êµ¬)",
    seoul_gu,
    index=0,
)

# 2) ì´ì‚¬ê°€ë ¤ëŠ” ì§€ì—­
moving_location = st.selectbox(
    "ì´ì‚¬ê°€ë ¤ëŠ” ì§€ì—­ (ì„œìš¸ 25ê°œ ìì¹˜êµ¬)",
    seoul_gu,
    index=0,
)

# 3) ì§ì¥Â·í•™êµ ìœ„ì¹˜
school_or_job_here = st.radio(
    "ì§ì¥ / í•™êµê°€ ì´ì‚¬ê°€ë ¤ëŠ” ì§€ì—­ì— ìœ„ì¹˜í•©ë‹ˆê¹Œ?",
    ["ì˜ˆ", "ì•„ë‹ˆì˜¤"],
    horizontal=True,
)

# 4) ì˜ˆìƒ ê±°ì£¼ ê¸°ê°„ (ì˜µì…˜ ì„ íƒí˜•)
stay_period = st.radio(
    "ì´ì‚¬ í›„ ì˜ˆìƒ ê±°ì£¼ ê¸°ê°„",
    ["2ë…„ ì´í•˜", "2~4ë…„", "4~10ë…„", "10ë…„ ì´ìƒ"],
    horizontal=False,
)


# 5) í˜„ì¬ ê±°ì£¼ì§€ ì²˜ë¦¬ ë°©ì‹
current_house_disposition = st.radio(
    "í˜„ì¬ ê±°ì£¼ì§€ë¥¼ ì–´ë–»ê²Œ ì²˜ë¦¬í•  ì˜ˆì •ì…ë‹ˆê¹Œ?",
    ["ë§¤ê°", "ì „Â·ì›”ì„¸", "ê³„ì† ê±°ì£¼", "í˜„ì¬ ì „Â·ì›”ì„¸ ê±°ì£¼ ì¤‘"],
    horizontal=False,
)

# 6) ì²­ì•½ í†µì¥ ë³´ìœ  ì—¬ë¶€
has_subscription = st.radio(
    "ì²­ì•½ í†µì¥ ë³´ìœ  ì—¬ë¶€",
    ["ìˆìŒ", "ì—†ìŒ"],
    horizontal=True,
)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“ ì •ì„±ì  ìš”ì¸ ì ìˆ˜ ê³„ì‚°  (ê°€ì¤‘ì¹˜ ì ìš© ì „)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) í˜„ì¬ ê±°ì£¼ì§€ = ì´ì‚¬ê°€ë ¤ëŠ” ê³³?
score_location = 100 if current_location == moving_location else 50

# 2) ì§ì¥Â·í•™êµ ìœ„ì¹˜
score_job_school = 100 if school_or_job_here == "ì˜ˆ" else 50

# 3) ì˜ˆìƒ ê±°ì£¼ ê¸°ê°„
stay_score_map = {
    "2ë…„ ì´í•˜": 25,
    "2~4ë…„": 50,
    "4~10ë…„": 75,
    "10ë…„ ì´ìƒ": 100,
}
score_stay = stay_score_map[stay_period]

# 4) í˜„ì¬ ê±°ì£¼ì§€ ì²˜ë¦¬ ë°©ì‹
disp_score_map = {
    "ë§¤ê°": 75,
    "ì „Â·ì›”ì„¸": 50,
    "ê³„ì† ê±°ì£¼": 25,
    "í˜„ì¬ ì „Â·ì›”ì„¸ ê±°ì£¼ ì¤‘": 100,
}
score_disposition = disp_score_map[current_house_disposition]

# 5) ì²­ì•½ í†µì¥
score_subscription = 100 if has_subscription == "ìˆìŒ" else 50

# ë”•ì…”ë„ˆë¦¬ë¡œ ëª¨ì•„ë‘ë©´ ê°€ì¤‘ì¹˜ ì ìš©ì´ í¸ë¦¬í•©ë‹ˆë‹¤
raw_scores = {
    "location": score_location,
    "job_school": score_job_school,
    "stay": score_stay,
    "disposition": score_disposition,
    "subscription": score_subscription,
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ¯ ê°€ì¤‘ì¹˜ ì •ì˜ (í¼ì„¼íŠ¸ â†’ ì†Œìˆ˜)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
weights = {
    "location":     0.20,  # í˜„ì¬ ê±°ì£¼ì§€ = ì´ì‚¬ê°€ë ¤ëŠ” ê³³?
    "job_school":   0.27,  # ì§ì¥Â·í•™êµ ìœ„ì¹˜
    "stay":         0.20,  # ì˜ˆìƒ ê±°ì£¼ ê¸°ê°„
    "disposition":  0.27,  # í˜„ì¬ ê±°ì£¼ì§€ ì²˜ë¦¬
    "subscription": 0.06,  # ì²­ì•½ í†µì¥ ë³´ìœ 
}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ§® ë¦¬ë¹™í• ìŠ¤ì½”ì–´ ê³„ì‚°í•˜ê¸° ë²„íŠ¼ â”€ í´ë¦­ ì‹œ ê²°ê³¼ ì¶œë ¥
if st.button("ğŸ§® ë¦¬ë¹™í• ìŠ¤ì½”ì–´ ê³„ì‚°í•˜ê¸°"):
    # 1) ê°€ì¤‘ì¹˜ ì ìš©
    livingfit_score = sum(raw_scores[k] * weights[k] for k in weights)

    # 2) ì í•©ë„ êµ¬ê°„ íŒì • + ì´ë¯¸ì§€ íŒŒì¼ ë§¤í•‘
    if livingfit_score >= 80:
        verdict = "ë§¤ìš° ì í•©"
        img_file = "very_good.png"   # ì˜ˆ: ./images/very_good.png
    elif livingfit_score >= 60:
        verdict = "ì í•©"
        img_file = "good.png"
    elif livingfit_score >= 40:
        verdict = "ë³´í†µ"
        img_file = "so_so.png"
    elif livingfit_score >= 20:
        verdict = "ë¶€ì í•©"
        img_file = "bad.png"
    else:
        verdict = "ë§¤ìš° ë¶€ì í•©"
        img_file = "very_bad.png"

    # 3) ê²°ê³¼ì— ë§ëŠ” ì´ë¯¸ì§€ í‘œì‹œ
    st.image(f"./images/{img_file}", use_container_width=True)

    # 4) ê²°ê³¼ í‘œì‹œ
    st.success(
        f"ë‚˜ì˜ ë¦¬ë¹™í• ìŠ¤ì½”ì–´ëŠ” **{livingfit_score:.1f}ì  / 100ì **  \n"
        f"â†’ **{verdict}**"
    )

    # 5) (ì„ íƒ) í•­ëª©ë³„ ì ìˆ˜ ìƒì„¸
    with st.expander("í•­ëª©ë³„ ì ìˆ˜ ìƒì„¸"):
        for k, v in raw_scores.items():
            st.write(f"- {k}: {v}ì  Ã— {weights[k]*100:.0f}% = {(v*weights[k]):.1f}ì ")

